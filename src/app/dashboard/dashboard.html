<div class="container" *ngIf="!isAdmin">
  <!-- Header with user greeting -->
  <div class="dashboard-header">
    <div class="greeting">
      <h1>¬°Hola, {{ username }}!</h1>
      <p>Aqu√≠ est√° tu resumen financiero</p>
    </div>
    <button mat-raised-button color="primary" (click)="goToNewTransaction()">
      <mat-icon>add</mat-icon>
      Nueva Transacci√≥n
    </button>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <mat-card class="summary-card balance">
      <mat-card-content>
        <div class="card-icon">üí∞</div>
        <div class="card-content">
          <p class="card-label">Saldo Actual</p>
          <h2 class="card-value">{{ currentBalance.toLocaleString('es-ES', {minimumFractionDigits: 2,
            maximumFractionDigits: 2}) }} ‚Ç¨</h2>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card income">
      <mat-card-content>
        <div class="card-icon">üìà</div>
        <div class="card-content">
          <p class="card-label">Ingresos del Mes</p>
          <h2 class="card-value">{{ currentMonthIncome.toLocaleString('es-ES', {minimumFractionDigits: 2,
            maximumFractionDigits: 2}) }} ‚Ç¨</h2>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card expenses">
      <mat-card-content>
        <div class="card-icon">üìâ</div>
        <div class="card-content">
          <p class="card-label">Gastos del Mes</p>
          <h2 class="card-value">{{ currentMonthExpenses.toLocaleString('es-ES', {minimumFractionDigits: 2,
            maximumFractionDigits: 2}) }} ‚Ç¨</h2>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card savings" [class.negative]="currentMonthSavings < 0">
      <mat-card-content>
        <div class="card-icon">{{ currentMonthSavings >= 0 ? '‚ú®' : '‚ö†Ô∏è' }}</div>
        <div class="card-content">
          <p class="card-label">Ahorro del Mes</p>
          <h2 class="card-value">{{ currentMonthSavings.toLocaleString('es-ES', {minimumFractionDigits: 2,
            maximumFractionDigits: 2}) }} ‚Ç¨</h2>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <!-- Income vs Expenses Chart -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>√öltimos 3 Meses</mat-card-title>
        <mat-card-subtitle>Comparaci√≥n de ingresos y gastos</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="bar-chart">
          <div class="chart-bars">
            <div class="bar-group" *ngFor="let data of chartData">
              <div class="bar-wrapper">
                <div class="bar income-bar" [style.height.%]="getBarHeight(data.income)">
                  <span class="bar-value">{{ data.income.toLocaleString('es-ES', {minimumFractionDigits: 2,
                    maximumFractionDigits: 2}) }} ‚Ç¨</span>
                </div>
                <div class="bar expense-bar" [style.height.%]="getBarHeight(data.expense)">
                  <span class="bar-value">{{ data.expense.toLocaleString('es-ES', {minimumFractionDigits: 2,
                    maximumFractionDigits: 2}) }} ‚Ç¨</span>
                </div>
              </div>
              <span class="bar-label">{{ data.month }}</span>
            </div>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <span class="legend-color income"></span>
              <span>Ingresos</span>
            </div>
            <div class="legend-item">
              <span class="legend-color expense"></span>
              <span>Gastos</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Income/Expense Percentage -->
    <mat-card class="chart-card percentage-card">
      <mat-card-header>
        <mat-card-title>Distribuci√≥n Mensual</mat-card-title>
        <mat-card-subtitle>Ingresos vs Gastos</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="percentage-content">
          <div class="percentage-circle">
            <svg viewBox="0 0 200 200">
              <circle cx="100" cy="100" r="80" fill="none" stroke="#e0e0e0" stroke-width="20" />
              <circle cx="100" cy="100" r="80" fill="none" stroke="#4caf50" stroke-width="20"
                [attr.stroke-dasharray]="(incomePercentage / 100) * 502.65 + ' 502.65'"
                transform="rotate(-90 100 100)" />
              <circle cx="100" cy="100" r="80" fill="none" stroke="#f44336" stroke-width="20"
                [attr.stroke-dasharray]="(expensesPercentage / 100) * 502.65 + ' 502.65'"
                [attr.stroke-dashoffset]="-(incomePercentage / 100) * 502.65" transform="rotate(-90 100 100)" />
            </svg>
            <div class="percentage-center">
              <span class="percentage-label">Balance</span>
            </div>
          </div>
          <div class="percentage-stats">
            <div class="percentage-row income-row">
              <span class="percentage-label">Ingresos</span>
              <span class="percentage-value">{{ incomePercentage.toFixed(1) }}%</span>
            </div>
            <div class="percentage-row expense-row">
              <span class="percentage-label">Gastos</span>
              <span class="percentage-value">{{ expensesPercentage.toFixed(1) }}%</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Bottom Section -->
  <div class="bottom-section">
    <!-- Concepto Distribution -->
    <mat-card class="chart-card conceptos-card">
      <mat-card-header>
        <mat-card-title>Gastos por Concepto</mat-card-title>
        <mat-card-subtitle>Top 3 del mes actual</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="conceptos-content">
          <div class="concepto-item" *ngFor="let concepto of topConceptos">
            <div class="concepto-info">
              <span class="concepto-name">{{ concepto.concepto }}</span>
              <span class="concepto-amount">{{ concepto.total.toLocaleString('es-ES', {minimumFractionDigits: 2,
                maximumFractionDigits: 2}) }} ‚Ç¨</span>
            </div>
            <div class="concepto-bar-wrapper">
              <div class="concepto-bar" [style.width.%]="getConceptoPercentage(concepto)"></div>
            </div>
            <span class="concepto-percentage">{{ getConceptoPercentage(concepto).toFixed(1) }}%</span>
          </div>
          <div class="no-data" *ngIf="conceptoDistribution.length === 0">
            <p>No hay gastos este mes</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Recent Transactions -->
    <mat-card class="chart-card transactions-card">
      <mat-card-header>
        <mat-card-title>Transacciones Recientes</mat-card-title>
        <mat-card-subtitle>√öltimas transacciones</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="transactions-content">
          <div class="transaction-item" *ngFor="let transaction of recentTransactions">
            <div class="transaction-icon" [class]="transaction.tipo.nombre.toLowerCase()">
              {{ transaction.tipo.nombre === 'INGRESO' ? '‚Üë' : '‚Üì' }}
            </div>
            <div class="transaction-info">
              <span class="transaction-concept">{{ transaction.concepto.nombre }}</span>
              <span class="transaction-date">{{ transaction.fecha }}</span>
            </div>
            <span class="transaction-amount" [class]="transaction.tipo.nombre.toLowerCase()">
              {{ transaction.tipo.nombre === 'INGRESO' ? '+' : '-' }} {{ transaction.cantidad.toLocaleString('es-ES',
              {minimumFractionDigits: 2, maximumFractionDigits: 2}) }} ‚Ç¨
            </span>
          </div>
          <div class="no-data" *ngIf="recentTransactions.length === 0">
            <p>No hay transacciones recientes</p>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-stroked-button (click)="goToFinanzas()" class="btn-view-all">Ver Todas</button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>